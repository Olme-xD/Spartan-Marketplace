<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="../images/img_test1.ico" />
    <title>Craig List — Notifications</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex-grow: 1;
        }

        .actions-col {
            flex: 0 0 260px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: .5rem;
            white-space: nowrap;
        }

        .actions-col .date {
            flex: 0 0 110px;
            text-align: right;
            color: #6c757d;
            font-size: .875rem;
        }

        .notification-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: .625rem;
            padding-bottom: .625rem;
        }

        .notification-unread {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="bg-light text-light d-flex flex-column min-vh-100">
    <!-- Header -->
    <div class="sticky-top container-fluid bg-dark text-light">
        <header class="d-flex justify-content-between align-items-center py-1">
            <a href="../index.html">
                <img style="width:70px;height:70px" src="../images/img_test1_white.png" alt="Logo"
                    class="img-fluid" />
            </a>
            <form class="col-md-4 d-flex" role="search" onsubmit="handleSearch(event)">
                <input id="searchInput" class="form-control rounded-pill me-2" type="search" placeholder="Search notifications…"
                    aria-label="Search" />
                <button class="btn btn-outline-light rounded-pill" type="submit">Search</button>
            </form>
            <nav class="d-flex align-items-center">
                <a href="profile.html" class="text-light text-decoration-none me-3">
                    <i class="bi bi-person-circle" style="font-size:30px"></i>
                </a>
                <a href="profile.html" class="text-light text-decoration-none me-3">Profile</a>
                <a href="dashboard.html" class="text-light text-decoration-none me-3">Dashboard</a>
                <a href="messages.html" class="text-light text-decoration-none me-3">Messages</a>
                <a href="notifications.html" class="text-light text-decoration-none me-3">Notifications</a>
                <a href="rating.html" class="text-light text-decoration-none me-3">Ratings</a>
                <a href="../index.html" class="btn btn-outline-light rounded-pill" onclick="logout()">Logout</a>
            </nav>
        </header>
    </div>

    <!-- Main -->
    <main class="container py-4 text-dark">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h4 mb-0">Notifications</h1>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllNotifications()">
                <i class="bi bi-trash"></i> Clear All
            </button>
        </div>

        <div class="list-group shadow-sm" id="notificationsList">
            <div class="list-group-item text-center">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                Loading notifications...
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light text-center py-3 mt-4">
        <p class="mb-0">&copy; 2025 Craig List App</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper to get cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        const userId = getCookie('user_id');
        const API_BASE = 'http://localhost:8080/api';

        // Redirect if not logged in
        if (!userId) {
            alert('Please login first');
            window.location.href = 'login.html';
        }

        let allNotifications = [];

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Generate notifications from real data
        async function loadNotifications() {
            try {
                allNotifications = [];

                // 1. NEW MESSAGES (received in last 7 days)
                const messagesResponse = await fetch(`${API_BASE}/messages/user/${userId}`);
                if (messagesResponse.ok) {
                    const messages = await messagesResponse.json();
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    
                    // Get only recent messages where the user received a message (is the seller)
                    for (const msg of messages) {
                        const isSeller = msg.sellerId == userId;
                        const hasBuyerText = msg.buyerText && msg.buyerText.trim() !== '';
                        const isRecent = new Date(msg.dateCreated) > sevenDaysAgo;
                        
                        if (isSeller && hasBuyerText && isRecent) {
                            try {
                                const userResponse = await fetch(`${API_BASE}/users/${msg.buyerId}`);
                                if (userResponse.ok) {
                                    const buyer = await userResponse.json();
                                    allNotifications.push({
                                        type: 'message',
                                        icon: 'bi-chat-dots-fill',
                                        iconColor: 'text-info',
                                        title: `New message from ${buyer.username}`,
                                        detail: msg.product?.title || 'Product',
                                        date: msg.dateCreated,
                                        link: 'messages.html',
                                        id: `msg-${msg.chatId}`
                                    });
                                }
                            } catch (err) {
                                console.error('Error fetching buyer info:', err);
                            }
                        }
                    }
                }

                // 2. NEW REVIEWS (received in last 30 days)
                const reviewsResponse = await fetch(`${API_BASE}/reviews/provider/${userId}`);
                if (reviewsResponse.ok) {
                    const reviews = await reviewsResponse.json();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    reviews.forEach(review => {
                        const isRecent = new Date(review.dateCreated) > thirtyDaysAgo;
                        if (isRecent) {
                            allNotifications.push({
                                type: 'review',
                                icon: 'bi-star-fill',
                                iconColor: 'text-warning',
                                title: `${review.user?.username || 'Someone'} left you a ${review.rating}-star review`,
                                detail: review.product?.title || 'Product',
                                date: review.dateCreated,
                                link: 'rating.html',
                                id: `review-${review.id}`
                            });
                        }
                    });
                }

                // 3. RECENT SALES (transactions in last 30 days)
                const transactionsResponse = await fetch(`${API_BASE}/transactions/provider/${userId}`);
                if (transactionsResponse.ok) {
                    const transactions = await transactionsResponse.json();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    for (const transaction of transactions) {
                        const isRecent = new Date(transaction.transactionDate) > thirtyDaysAgo;
                        if (isRecent) {
                            try {
                                const buyerResponse = await fetch(`${API_BASE}/users/${transaction.user.id}`);
                                if (buyerResponse.ok) {
                                    const buyer = await buyerResponse.json();
                                    allNotifications.push({
                                        type: 'sale',
                                        icon: 'bi-currency-dollar',
                                        iconColor: 'text-success',
                                        title: `${buyer.username} purchased "${transaction.product.title}"`,
                                        detail: `$${transaction.product.price}`,
                                        date: transaction.transactionDate,
                                        link: 'dashboard.html',
                                        id: `sale-${transaction.id}`
                                    });
                                }
                            } catch (err) {
                                console.error('Error fetching buyer info for transaction:', err);
                            }
                        }
                    }
                }

                // Sort by date (newest first)
                allNotifications.sort((a, b) => new Date(b.date) - new Date(a.date));

                renderNotifications(allNotifications);

            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notificationsList').innerHTML = 
                    '<div class="list-group-item text-danger">Failed to load notifications. Please try again.</div>';
            }
        }

        // Render notifications
        function renderNotifications(notifications) {
            const container = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center py-5">
                        <i class="bi bi-bell-slash" style="font-size: 3rem; color: #dee2e6;"></i>
                        <p class="text-muted mt-3 mb-0">No recent notifications</p>
                        <small class="text-muted">You'll see messages, reviews, and sales here</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            notifications.forEach(notif => {
                const notifDiv = document.createElement('div');
                notifDiv.className = 'list-group-item notification-row';
                notifDiv.setAttribute('data-id', notif.id);

                notifDiv.innerHTML = `
                    <div>
                        <i class="bi ${notif.icon} ${notif.iconColor} me-2"></i>
                        <strong>${notif.title}</strong>
                        ${notif.detail ? `<span class="text-muted"> — ${notif.detail}</span>` : ''}
                    </div>
                    <div class="actions-col">
                        <a href="${notif.link}" class="btn btn-sm btn-outline-primary">View</a>
                        <button class="btn btn-sm btn-outline-secondary" onclick="dismissNotification('${notif.id}')">Dismiss</button>
                        <span class="date">${formatDate(notif.date)}</span>
                    </div>
                `;

                container.appendChild(notifDiv);
            });
        }

        // Dismiss a notification
        function dismissNotification(notifId) {
            const notifElement = document.querySelector(`[data-id="${notifId}"]`);
            if (notifElement) {
                notifElement.remove();
                
                // Remove from array
                allNotifications = allNotifications.filter(n => n.id !== notifId);
                
                // Check if empty
                if (allNotifications.length === 0) {
                    document.getElementById('notificationsList').innerHTML = `
                        <div class="list-group-item text-center py-5">
                            <i class="bi bi-bell-slash" style="font-size: 3rem; color: #dee2e6;"></i>
                            <p class="text-muted mt-3 mb-0">No recent notifications</p>
                            <small class="text-muted">You'll see messages, reviews, and sales here</small>
                        </div>
                    `;
                }
            }
        }

        // Clear all notifications
        function clearAllNotifications() {
            if (!confirm('Are you sure you want to clear all notifications?')) {
                return;
            }

            allNotifications = [];
            document.getElementById('notificationsList').innerHTML = `
                <div class="list-group-item text-center py-5">
                    <i class="bi bi-bell-slash" style="font-size: 3rem; color: #dee2e6;"></i>
                    <p class="text-muted mt-3 mb-0">No recent notifications</p>
                    <small class="text-muted">You'll see messages, reviews, and sales here</small>
                </div>
            `;
        }

        // Search notifications
        function handleSearch(event) {
            event.preventDefault();
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!query) {
                renderNotifications(allNotifications);
                return;
            }

            const filtered = allNotifications.filter(notif => {
                return notif.title.toLowerCase().includes(query) ||
                       (notif.detail && notif.detail.toLowerCase().includes(query));
            });

            renderNotifications(filtered);
        }

        // Logout function
        function logout() {
            document.cookie = 'user_session=; path=/; max-age=0';
            document.cookie = 'user_id=; path=/; max-age=0';
            window.location.href = '../index.html';
        }

        // Load notifications on page load
        loadNotifications();

        // Refresh notifications every 60 seconds
        setInterval(loadNotifications, 60000);
    </script>
</body>

</html>