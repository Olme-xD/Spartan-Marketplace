<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="../images/img_test1.ico" />
    <title>Craig List — New / Edit Listing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
    </style>
</head>

<body class="bg-light text-dark d-flex flex-column min-vh-100">

    <div class="sticky-top container-fluid bg-dark text-light">
        <header class="d-flex justify-content-between align-items-center py-1">
            <a href="../index.html">
                <img style="width:70px;height:70px" src="images/img_test1_white.png" alt="Logo" class="img-fluid"/>
            </a>
            <form class="col-md-4 d-flex" role="search" onsubmit="event.preventDefault()">
                <input class="form-control rounded-pill me-2" type="search" placeholder="Search" />
                <button class="btn btn-outline-light rounded-pill" type="submit">Search</button>
            </form>
            <nav class="d-flex align-items-center">
                <a href="dashboard.html" class="text-light text-decoration-none me-3">
                    <i class="bi bi-person-circle" style="font-size:30px"></i>
                </a>
                <a href="dashboard.html" class="text-light text-decoration-none me-3">Dashboard</a>
                <a href="messages.html" class="text-light text-decoration-none me-3">Messages</a>
                <a href="notifications.html" class="text-light text-decoration-none me-3">Notifications</a>
                <a href="rating.html" class="text-light text-decoration-none me-3">Ratings</a>
                <a href="../index.html" class="btn btn-outline-light rounded-pill">Logout</a>
            </nav>
        </header>
    </div>

    <main class="container py-4">
        <h1 id="pageTitle" class="h4 mb-3">Create a New Listing</h1>
        <div id="editingBadge" class="badge text-bg-secondary mb-3 d-none"></div>

        <form id="listingForm" class="bg-white p-4 rounded shadow-sm" onsubmit="event.preventDefault(); handleSave();">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="form-label">Title</label>
                    <input id="title" class="form-control" placeholder="e.g., 2020 MacBook Pro" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input id="price" type="number" min="0" step="0.01" class="form-control" value="0" required />
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Category</label>
                    <select id="category" class="form-select" required>
                        <option value="" disabled selected>Choose…</option>
                        <option>Electronics</option>
                        <option>Vehicles</option>
                        <option>Furniture</option>
                        <option>Clothing</option>
                        <option>Books</option>
                        <option>Real Estate</option>
                        <option>Services</option>
                        <option>Miscellaneous</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Contact Email</label>
                    <input id="email" type="email" class="form-control" placeholder="seller@example.com" />
                </div>

                <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea id="description" class="form-control" rows="5"
                        placeholder="Write a clear description"></textarea>
                </div>

                <div class="col-12">
                    <label class="form-label">Images <span class="text-danger">*</span></label>
                    <input id="images" type="file" class="form-control" accept="image/*" />
                    <div class="form-text">An image is required for new listings.</div>
                </div>
            </div>

            <div class="mt-3 d-flex gap-2">
                <button id="submitBtn" class="btn btn-success" type="submit">Save Listing</button>
                <a class="btn btn-outline-secondary" href="dashboard.html#manage">Cancel</a>
            </div>
        </form>
    </main>

    <footer class="bg-dark text-light text-center py-3 mt-4">
        <p class="mb-0">&copy; 2025 Craig List App</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper to get cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Convert File to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        const API_BASE = "http://localhost:8080/api";
        const qs = new URLSearchParams(window.location.search);
        const editId = qs.get("id"); 
        const userId = getCookie("user_id");
        let currentProductId = null;

        // Prefill form if editing an existing listing
        async function prefillIfEditing() {
            if (!editId) return;
            if (!userId) { 
                alert("Please login first"); 
                window.location.href = "../index.html"; 
                return; 
            }

            document.title = "Craig List — Edit Listing";
            document.getElementById("pageTitle").textContent = "Edit Listing";
            document.getElementById("submitBtn").textContent = "Update Listing";
            document.getElementById("editingBadge").textContent = `Editing Listing #${editId}`;
            document.getElementById("editingBadge").classList.remove("d-none");

            try {
                const response = await fetch(`${API_BASE}/listings/${editId}`);
                if (!response.ok) throw new Error("Listing not found");
                
                const listing = await response.json();
                document.getElementById("category").value = listing.category;

                if (listing.products && listing.products.length > 0) {
                    const product = listing.products[0];
                    currentProductId = product.id; 
                    document.getElementById("title").value = product.title;
                    document.getElementById("price").value = product.price;
                    document.getElementById("description").value = product.description;
                }
            } catch (error) { 
                console.error(error); 
                alert("Error fetching listing data."); 
            }
        }

        // Handle form submission
        async function handleSave() {
            if (!userId) { 
                alert("User session not found. Please login."); 
                return; 
            }

            const title = document.getElementById("title").value;
            const price = document.getElementById("price").value;
            const category = document.getElementById("category").value;
            const description = document.getElementById("description").value;
            const fileInput = document.getElementById("images");

            // Validate image for new listings
            if (!editId && fileInput.files.length === 0) {
                alert("Image is required for new listings!");
                return;
            }

            try {
                // Prepare listing container payload
                const listingPayload = {
                    category: category,
                    user: { id: parseInt(userId) },
                    isActive: true
                };

                let listingId = editId;

                if (!editId) {
                    // Create listing wrapper
                    const listResp = await fetch(`${API_BASE}/listings`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(listingPayload)
                    });
                    
                    if (!listResp.ok) {
                        const errorText = await listResp.text();
                        throw new Error("Failed to create listing: " + errorText);
                    }
                    
                    const savedListing = await listResp.json();
                    listingId = savedListing.id;

                    // Create product with image
                    const productData = {
                        title: title,
                        price: price,
                        description: description,
                        condition: "Good",
                        listing: { id: listingId },
                        user: { id: parseInt(userId) },
                        isActive: true,
                        imageURLString: "pending_upload" 
                    };

                    const formData = new FormData();
                    formData.append("product", new Blob([JSON.stringify(productData)], { type: "application/json" }));
                    formData.append("file", fileInput.files[0]);

                    const prodResp = await fetch(`${API_BASE}/products`, {
                        method: "POST",
                        body: formData 
                    });
                    
                    if (!prodResp.ok) {
                        const errorText = await prodResp.text();
                        throw new Error("Product save failed: " + errorText);
                    }
                    
                    alert("Listing Created Successfully!");

                } else {
                    // Update listing wrapper
                    await fetch(`${API_BASE}/listings/${editId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(listingPayload)
                    });

                    // Update product details
                    if (currentProductId) {
                         const productPayload = {
                            title: title,
                            price: price,
                            description: description,
                            condition: "Good",
                            listing: { id: parseInt(editId) },
                            user: { id: parseInt(userId) },
                            isActive: true
                        };
                        
                        // Handle image update manually if a new file is selected
                        if (fileInput.files.length > 0) {
                             productPayload.imageURLString = await toBase64(fileInput.files[0]);
                        }

                        const updateResp = await fetch(`${API_BASE}/products/${currentProductId}`, {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(productPayload)
                        });
                        
                        if (!updateResp.ok) {
                            const errorText = await updateResp.text();
                            throw new Error("Product update failed: " + errorText);
                        }
                    }
                    alert("Listing Updated Successfully!");
                }

                window.location.href = "dashboard.html#manage";

            } catch (error) {
                console.error("Save failed:", error);
                alert(error.message);
            }
        }

        prefillIfEditing();
    </script>
</body>

</html>